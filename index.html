<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Stroop Demo — Learn by Doing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS first so we can show a loading/error message -->
  <style>
    :root { color-scheme: dark; }
    body { margin:0; background:#191919; color:#eee; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width: 980px; margin: 32px auto; padding: 0 16px; }
    .muted { color:#aaa; font-size: 16px; }
    .big { font-size: 48px; }
    .ink { font-weight: 800; font-size: 96px; letter-spacing: 2px; }
    .row { margin: 6px 0; }
    .btn { display:inline-block; padding:10px 14px; border:1px solid #777; border-radius:8px; text-decoration:none; color:#eee; margin-top:10px;}
    .btn:hover { background:#333; }
    .center { text-align:center; }
    #status { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; pointer-events:none; }
    #status .card { background:#111; border:1px solid #333; border-radius:12px; padding:16px 20px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .ok { color:#7CFC00; }
    .err { color:#ff6b6b; }
  </style>

  <!-- Prefer jsDelivr; keep unpkg as backup -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspsych@7.3.3/dist/jspsych.js"></script>
  <link  rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/@jspsych/plugin-html-keyboard-response@1.2.0"></link>
  <script defer src="https://cdn.jsdelivr.net/npm/@jspsych/plugin-html-keyboard-response@1.2.0"></script>

  <!-- Fallback CDNs if first ones fail -->
  <script>
    (function(){
      // If jsPsych hasn't appeared after 3s, try unpkg as a fallback
      function loadFallback() {
        if (window.jsPsych) return;
        var s1 = document.createElement('script');
        s1.src = 'https://unpkg.com/jspsych@7.3.3/dist/jspsych.js';
        s1.defer = true;
        document.head.appendChild(s1);
        var s2 = document.createElement('script');
        s2.src = 'https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.2.0';
        s2.defer = true;
        document.head.appendChild(s2);
      }
      setTimeout(loadFallback, 3000);
    })();
  </script>
</head>
<body>
<div id="jspsych-target" class="wrap"></div>

<!-- Status / error overlay -->
<div id="status">
  <div class="card">
    <div id="status-msg">Loading…</div>
    <div class="muted">If this stays here, you might be offline or a script failed to load.</div>
  </div>
</div>

<script>
  // Utility: show status or error visibly on the page (not just console)
  function setStatus(html, cls) {
    const el = document.getElementById('status-msg');
    el.innerHTML = html;
    el.className = cls || '';
  }
  window.addEventListener('error', function(e){
    setStatus('Error: ' + (e.message || 'A script failed to load'), 'err');
  });

  // Wait for scripts to be ready
  window.addEventListener('load', function(){
    // Give the deferred scripts a tick
    setTimeout(startApp, 50);
  });

  function startApp(){
    if (!window.initJsPsych || !window.jsPsychHtmlKeyboardResponse) {
      setStatus('Could not load jsPsych. Hard refresh (Ctrl/Cmd+Shift+R) or check CDN access.', 'err');
      return;
    }

    setStatus('<span class="ok">Loaded. Initializing…</span>', 'ok');

    // ===== Config =====
    const PRACTICE_TRIALS = 8;
    const MAIN_TRIALS = 24;
    const ITI_MS = 350;
    const COLORS = ["red","green","blue","yellow"];
    const COLOR_RGB = {
      red:    "rgb(255,0,0)",
      green:  "rgb(0,200,0)",
      blue:   "rgb(0,120,255)",
      yellow: "rgb(255,210,0)"
    };
    const KEYMAP = { r:"red", g:"green", b:"blue", y:"yellow" };

    // From your dataset summary:
    const POP_EFFECT_MS = 314;
    const MIN_RT = 200;
    const MAX_RT = 3000;

    // ===== Helpers =====
    function makeBalancedTrials(n) {
      const half = Math.floor(n/2);
      const conds = Array(half).fill(true).concat(Array(n - half).fill(false)); // true=congruent
      for (let i=conds.length-1;i>0;i--) { const j = Math.floor(Math.random()*(i+1)); [conds[i],conds[j]]=[conds[j],conds[i]]; }
      const trials = [];
      conds.forEach(congruent => {
        const word = COLORS[Math.floor(Math.random()*COLORS.length)];
        let ink = word;
        if (!congruent) ink = COLORS.filter(c=>c!==word)[Math.floor(Math.random()*3)];
        trials.push({word, ink, congruent});
      });
      return trials;
    }
    function resultsCSV(trials) {
      const header = ["block","trial","word","ink","congruent","response_color","correct","rt_ms"];
      const rows = trials.map((t,i) => [t.block, i+1, t.word, t.ink, t.congruent, t.response_color ?? "", t.correct, Math.round(t.rt)]);
      return [header.join(","), ...rows.map(r=>r.join(","))].join("\n");
    }
    function download(filename, text) {
      const a = document.createElement("a");
      a.href = URL.createObjectURL(new Blob([text], {type:"text/csv"}));
      a.download = filename;
      a.click();
    }
    function mean(arr) {
      const xs = arr.filter(Number.isFinite);
      return xs.length ? xs.reduce((a,b)=>a+b,0)/xs.length : NaN;
    }
    function summarize(trials) {
      const correct = trials.filter(t => t.correct && t.rt >= MIN_RT && t.rt <= MAX_RT);
      const cong = mean(correct.filter(t => t.congruent).map(t => t.rt));
      const incong = mean(correct.filter(t => !t.congruent).map(t => t.rt));
      return { cong_ms: cong, incong_ms: incong, effect_ms: (incong - cong) };
    }

    // ===== Build timeline =====
    const jsPsych = initJsPsych({display_element: 'jspsych-target'});

    function screenHTML(inner) { return `<div class="wrap center">${inner}</div>`; }

    const intro1 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: screenHTML(`
        <h2>What are we testing?</h2>
        <div class="row">Does the <b>meaning</b> of a color word interfere with naming its <b>INK COLOR</b>?</div>
        <div class="row">Example: the word <b>RED</b> printed in <span style="color:${COLOR_RGB.green}">green</span> — do you respond slower?</div>
        <div class="row muted">Press SPACE to continue…</div>
      `),
      choices: [' ']
    };

    const intro2 = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: screenHTML(`
        <h2>Your task</h2>
        <div class="row">Say the <b>INK COLOR</b>, not the word.</div>
        <div class="row">Use your keyboard: <b>R</b>=red, <b>G</b>=green, <b>B</b>=blue, <b>Y</b>=yellow</div>
        <div class="row muted">Press SPACE to see examples…</div>
      `),
      choices: [' ']
    };

    const examples = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: screenHTML(`
        <h2>Examples</h2>
        <div style="display:flex; gap:40px; justify-content:center; margin-top:10px;">
          <div>
            <div class="row" style="color:#0f0">Congruent</div>
            <div class="ink" style="color:${COLOR_RGB.red}">RED</div>
          </div>
          <div>
            <div class="row" style="color:#f90">Incongruent</div>
            <div class="ink" style="color:${COLOR_RGB.green}">RED</div>
          </div>
        </div>
        <div class="row" style="margin-top:30px;">Say the <b>INK COLOR</b>, not the word.</div>
        <div class="row muted">Press SPACE to try a short practice…</div>
      `),
      choices: [' ']
    };

    function trialHTML(word, ink, footer="R=red  G=green  B=blue  Y=yellow") {
      return screenHTML(`
        <div class="row muted">Name the INK COLOR (not the word)</div>
        <div class="ink" style="color:${COLOR_RGB[ink]}">${word.toUpperCase()}</div>
        <div class="row muted" style="margin-top:26px;">${footer}</div>
      `);
    }

    function buildTrials(blockName, nTrials, withFeedback=true) {
      const vars = makeBalancedTrials(nTrials);
      const trials = [];
      vars.forEach((v) => {
        trials.push({
          type: jsPsychHtmlKeyboardResponse,
          stimulus: trialHTML(v.word, v.ink),
          choices: ['r','g','b','y','R','G','B','Y'],
          data: { block: blockName, word: v.word, ink: v.ink, congruent: v.congruent },
          on_finish: (data) => {
            const key = (data.response || '').toLowerCase();
            const color = ({r:'red', g:'green', b:'blue', y:'yellow'})[key] || null;
            data.response_color = color;
            data.correct = (color === v.ink);
          }
        });
        if (withFeedback) {
          trials.push({
            type: jsPsychHtmlKeyboardResponse,
            stimulus: function(){
              const last = jsPsych.data.get().last(1).values()[0];
              const ok = last.correct;
              const ink = last.ink.toUpperCase();
              const msg = ok ? "Correct!" : `Incorrect — correct was ${ink}`;
              const col = ok ? "#0f0" : "#f64";
              return screenHTML(`<div class="big" style="color:${col}">${msg}</div>`);
            },
            choices: "NO_KEYS",
            trial_duration: ITI_MS
          });
        }
      });
      return trials;
    }

    const practiceIntro = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: screenHTML(`
        <h2>Practice</h2>
        <div class="row">Try a few trials with feedback.</div>
        <div class="row muted">Press SPACE to start practice…</div>
      `),
      choices: [' ']
    };

    const practiceTrials = buildTrials("practice", PRACTICE_TRIALS, true);

    const practiceSummary = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function(){
        const prac = jsPsych.data.get().filter({block:"practice"}).values();
        const sum = summarize(prac);
        const cong = Math.round(sum.cong_ms);
        const incong = Math.round(sum.incong_ms);
        const eff = Math.round(sum.effect_ms);
        return screenHTML(`
          <h2>Practice Summary</h2>
          <div class="row">Congruent ≈ <b>${cong} ms</b> &nbsp; Incongruent ≈ <b>${incong} ms</b></div>
          <div class="row">Your practice Stroop effect ≈ <b>${eff} ms</b></div>
          <div class="row muted">Press SPACE to begin the main test…</div>
        `);
      },
      choices: [' ']
    };

    const mainIntro = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: screenHTML(`
        <h2>Main Test</h2>
        <div class="row">Now you'll complete ${MAIN_TRIALS} trials.</div>
        <div class="row">Try to be accurate <i>and</i> fast.</div>
        <div class="row muted">Press SPACE to start…</div>
      `),
      choices: [' ']
    };

    const mainTrials = buildTrials("main", MAIN_TRIALS, true);

    const mainSummary = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function(){
        const main = jsPsych.data.get().filter({block:"main"}).values();
        const sum = summarize(main);
        const cong = Math.round(sum.cong_ms);
        const incong = Math.round(sum.incong_ms);
        const eff = Math.round(sum.effect_ms);
        const verdict = (eff < POP_EFFECT_MS)
          ? `<span style="color:#0f0">You showed less interference than the dataset average! 🧠</span>`
          : `<span style="color:#f64">Your interference was larger than the dataset average. ⏳</span>`;
        return screenHTML(`
          <h2>Your Results</h2>
          <div class="row">Stroop effect = Incongruent RT − Congruent RT</div>
          <div class="row" style="margin-top:14px;">Congruent ≈ <b>${cong} ms</b> &nbsp; Incongruent ≈ <b>${incong} ms</b></div>
          <div class="row">Your Stroop effect ≈ <b>${eff} ms</b></div>
          <div class="row" style="margin-top:10px;">Dataset average ≈ <b>${POP_EFFECT_MS} ms</b></div>
          <div class="row" style="margin-top:16px;">${verdict}</div>
          <div class="row" style="margin-top:24px;">
            <a class="btn" id="dl">Download my data (CSV)</a>
          </div>
          <div class="row muted">Press SPACE to finish…</div>
        `);
      },
      choices: [' '],
      on_load: function(){
        const dataAll = jsPsych.data.get().values();
        const csv = resultsCSV(dataAll);
        const btn = document.getElementById('dl');
        if (btn) btn.addEventListener('click', () => download('stroop_results.csv', csv));
      }
    };

    const endScreen = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: screenHTML(`
        <h2>Thank you!</h2>
        <div class="row">This demo shows how automatic reading can interfere with naming colors.</div>
        <div class="row">Share this link so others can try it.</div>
        <div class="row muted">You may close the tab.</div>
      `),
      choices: "NO_KEYS",
      trial_duration: 2000
    };

    jsPsych.run([intro1, intro2, examples, practiceIntro, ...practiceTrials, practiceSummary, mainIntro, ...mainTrials, mainSummary, endScreen]);

    // hide status overlay once we start
    document.getElementById('status').style.display = 'none';
  }
</script>
</body>
</html>
